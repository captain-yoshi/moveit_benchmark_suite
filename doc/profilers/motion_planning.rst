===============
Motion Planning
===============
The motion planning can be tested against the PlanningPipeline (PP) and the MoveGroupInterface (MGI). The latter should be slower as the request is forwarded through the actionlib stack.

Metrics
-------

This table was taken from the `Shadow Robot Company`_.

================  =====================================================================================
Name              Description
================  =====================================================================================
Time (s)          | Time taken by the whole process. Formula:
                  | T = plan_time  + interpolation_time + simplify_time + plugin_time + process_time
                  | *The lower the value, the better performance of the planner.*

Length (rad)      | Calculated by a sum of angles traveled by each of the joints. Formula:
                  | L = sum :sub:`i=0`:sup:`n-1` {abs(x\ :sub:`i` - x\ :sub:`i0`)}, where:
                  | n - number of robot's joints,
                  | x - joint's goal position,
                  | x\ :sub:`0` - joint's initial position.
                  | *The lower the value, the better the plan.*

Smoothness        | Looks at three consecutive waypoints and the angle formed between them.
                  | Value is calculated as a square of sum of all the angles calculated that way. Formula:
                  | S = sum\ :sub:`i=2`:sup:`n-1` {(2 :sub:`*` (pi - arccos((d\ :sub:`i-2,i-1`:sup:`2` + d\ :sub:`i-1,i`:sup:`2` - d\ :sub:`i-2,i`:sup:`2`)/(2 :sub:`*` d\ :sub:`i-2,i-1` \ :sub:`*` d\ :sub:`i-1,i`))))\ :sup:`2`\ }, where:
                  | n - number of waypoints on the path,
                  | d\ :sub:`x,y`  - distance between waypoints with index x and y.
                  | Aligned points result in S = 0.
                  | *The lower the value, the smoother plan.*
                  |

Clearance (m)     | Calculated by average distance to nearest invalid state (obstacle) throughout the planned path. Formula:
                  | C = (1/n) :sub:`*` sum\ :sub:`i=0`\ :sup:`n-1` {cl(s\ :sub:`i`)}, where:
                  | n - number of states on path,
                  | s\ :sub:`i` - ith state,
                  | cl() - distance to the first invalid state.
                  | *The higher the value, the better the plan.**

Waypoints         Number of waypoints of the trajectory.

Solved            Weither a planner was able to find a solution for.

Correct           | Solved plans generated by the planner that are correct.
                  | Correctness means that path trajectory avoids collisions and all waypoints satisfy given bounds.
================  =====================================================================================


Run |--| PP
-----------

Launch the `motion_planning_pp.launch`_ benchmark node. Check the `benchmark`_ section for a list of available parameters.

.. code-block:: console

  $ roslaunch moveit_benchmark_suite motion_planning_pp.launch


Configuration |--| PP
---------------------

The `motion_planning_pp.yaml`_ file contains the necessary configuration for running the benchmark.

.. code-block:: yaml

  benchmark_config:
    parameters:
      runs: 20                        # Number of trials for each query
      name: "MotionPlanning PP"       # Default ""    | Overridden by ROS Param /benchmark/name
      visualize: false                # Default false | Overridden by ROS Param /benchmark/visualize
      output_file: ""                 # Default ""    | Overridden by ROS Param /benchmark/output_file

  profiler_config:
    # Override 'requests' with moveit_msgs/MotionPlanRequest respective field/s
    requests_override:
      allowed_planning_time: 10.0
      num_planning_attempts: 1

    # Resource moveit_msgs/MotionPlanRequest
    requests:
      - name: jc
        resource: package://moveit_benchmark_suite_resources/requests/bbt/panda/jc.yaml
      # - name: jc_pcp
      #   resource: package://moveit_benchmark_suite_resources/requests/bbt/panda/jc_pcp.yaml

    # Resource moveit_config (robot)
    robot:
      name: panda
      resources:
        urdf: package://moveit_benchmark_suite_resources/robots/panda/urdf/panda.urdf
        srdf: package://moveit_benchmark_suite_resources/robots/panda/config/panda.srdf
        kinematics: package://moveit_benchmark_suite_resources/robots/panda/config/kinematics.yaml
        joint_limits: package://moveit_benchmark_suite_resources/robots/panda/config/joint_limits.yaml

    # Resource moveit_msgs/PlanningScene
    scenes:
      - name: empty
        resource: package://moveit_benchmark_suite_resources/scenes/empty/empty.urdf.xacro
      - name: primitive
        resource: package://moveit_benchmark_suite_resources/scenes/bbt/panda/primitive.urdf.xacro
      # - name: mesh
      #   resource: package://moveit_benchmark_suite_resources/scenes/bbt/panda/mesh_16k.urdf.xacro

    collision_detectors:
      - FCL
      - Bullet

    # Resource moveit_config (planning pipeline)
    # - Override the 'requests' pipeline_id field
    # - Extends query 'planners' which overrides the 'requests' planner_id field
    planning_pipelines:
      - name: ompl
        resource: package://moveit_benchmark_suite_resources/robots/panda/config/ompl_planning.yaml
        parameters:
          planners:
            - RRT
            - RRTConnect
            - EST
            - PRM
            - LBKPIECE
            - BiEST
      # - name: chomp
      #   resource: package://moveit_benchmark_suite_resources/robots/panda/config/chomp_planning.yaml
      #   parameters:
      #     planners:
      #       - CHOMP

Run |--| MGI
------------

Launch the `motion_planning_mgi.launch`_ benchmark node. Check the `benchmark`_ section for a list of available parameters.

.. code-block:: console

  $ roslaunch moveit_benchmark_suite motion_planning_mgi.launch

This also launches the ``demo`` node from the ``moveit_resources_panda_moveit_config`` package. To benchmark another robot, you must change the XXX_moveit_config node in the launcher.


Configuration |--| MGI
----------------------

The `motion_planning_mgi.yaml`_ file contains the necessary configuration for running the benchmark.

The config is identical to the PlanningPipeline config but the ``robot`` and ``planning_pipelines`` resources are ROS Param namespaces that defaults to a moveit_config namespace.

.. code-block:: yaml

  benchmark_config:
    parameters:
      runs: 20                        # Number of trials for each query
      name: "MotionPlanning MGI"      # Default ""    | Overridden by ROS Param /benchmark/name
      visualize: false                # Default false | Overridden by ROS Param /benchmark/visualize
      output_file: ""                 # Default ""    | Overridden by ROS Param /benchmark/output_file

  profiler_config:
    # Override 'requests' with moveit_msgs/MotionPlanRequest respective field/s
    requests_override:
      allowed_planning_time: 10.0
      num_planning_attempts: 1

    # Resource moveit_msgs/MotionPlanRequest
    requests:
      - name: jc
        resource: package://moveit_benchmark_suite_resources/requests/bbt/panda/jc.yaml
      # - name: jc_pcp
      #   resource: package://moveit_benchmark_suite_resources/requests/bbt/panda/jc_pcp.yaml

    # Resource moveit_config (robot)
    robot:
      name: panda
      resources:
        urdf: /robot_description
        srdf: /robot_description_semantic
        kinematics: /robot_description_kinematics
        joint_limits: /robot_description_planning/joint_limits

    # Resource moveit_msgs/PlanningScene
    scenes:
      - name: empty
        resource: package://moveit_benchmark_suite_resources/scenes/empty/empty.urdf.xacro
      - name: primitive
        resource: package://moveit_benchmark_suite_resources/scenes/bbt/panda/primitive.urdf.xacro
      # - name: mesh
      #   resource: package://moveit_benchmark_suite_resources/scenes/bbt/panda/mesh_16k.urdf.xacro

    collision_detectors:
      - FCL
      - Bullet

    # Resource moveit_config (planning pipeline)
    # - Override the 'requests' pipeline_id field
    # - Extends query 'planners' which overrides the 'requests' planner_id field
    planning_pipelines:
      - name: ompl
        resource: /move_group/planning_pipelines/ompl
        parameters:
          planners:
            - RRT
            - RRTConnect
            - EST
            - PRM
            - LBKPIECE
            - BiEST
      # - name: chomp
      #   resource: /move_group/planning_pipelines/chomp
      #   parameters:
      #     planners:
      #       - CHOMP

.. Declaration of hyperlinks
.. _Shadow Robot Company: https://github.com/shadow-robot/sr_benchmarking/blob/kinetic-devel/docs/user_guide/3_benchmark_description.md#benchmark-metrics
.. _motion_planning_pp.launch: /moveit/benchmarks/motion_planning_pp.launch
.. _motion_planning_mgi.launch: /moveit/benchmarks/motion_planning_mgi.launch
.. _benchmark: /doc/README.md#benchmark
.. _motion_planning_pp.yaml: /moveit/config/motion_planning_pp.yaml
.. _motion_planning_mgi.yaml: /moveit/config/motion_planning_mgi.yaml

.. Declaration of unicode dash
.. |--| unicode:: U+2013   .. en dash
.. |---| unicode:: U+2014  .. em dash, trimming surrounding whitespace
   :trim:
